module topLevelControl_mod
!
! ***NOTE:*** The compilation script will automatically create topLevelControl_mod.ftn90 from this file
!
!     Control variables for the job - constant within job
!
!     TOP_CREVISION : string parameter that will be replaced by the compilation
!                     script to contain the latest SVN global revision number 
!                     (trailing "M" indicates working directory is "modified" 
!                     relative to the repository version)
!     TOP_NCONF     : configuration of the job
!
  implicit none
  save
  private

  ! public variables
  public :: top_crevision
  ! public procedures
  public :: top_setup, top_AnalysisMode, top_BgckIrMode, top_BgckConvMode, top_OmpMode
  public :: top_BurpSplit, top_BurpSplitMode
  public :: top_spatialDimensions, top_AnalysisLevel2d

  character(len=len('XXXXX')),parameter :: top_crevision='XXXXX'
  character(len=2) :: top_spatial_Dimensions
  integer :: top_nconf, top_ip1

  character(len=256) :: burp_split_mode
  logical :: burp_split_L

  contains

!--------------------------------------------------------------------------
! top_setup
!--------------------------------------------------------------------------
    subroutine top_setup
      implicit none
      integer :: nconf, ip1
      character(len=2) :: spatialDimensions

      NAMELIST /NAMCT0/NCONF,spatialDimensions,ip1
      integer nulnam,ierr,fnom,fclos 

      integer :: length_burp_split, status

      ! Set the default values
      nconf             = 141
      spatialDimensions = '3D'   ! default value
      ip1               = -1     ! default value

      ! Read the NAMELIST to modify these values
      nulnam=0
      ierr=fnom(nulnam,'./flnml','FTN+SEQ+R/O',0)
      if(ierr.ne.0) call varAbort('top_setup: Error opening file flnml')
      read(nulnam,nml=namct0,iostat=ierr)
      if(ierr.ne.0) call varAbort('top_setup: Error reading namelist')
      write(*,nml=namct0)
      ierr=fclos(nulnam)

      top_nconf              = nconf
      top_spatial_Dimensions = spatialDimensions
      top_ip1                = ip1

      !
      !- Determine if the observation files are already split by subdomain
      !
      status = 0
      call get_environment_variable('ARMA_BURP_SPLIT',burp_split_mode,length_burp_split,status,.true.)

      if (status.gt.1) then
        write(*,*) 'top_setup: Problem when getting the environment variable ARMA_BURP_SPLIT'
      end if
      if (status.eq.1) then
        write(*,*) 'top_setup: The environment variable ARMA_BURP_SPLIT has not been detected!'
	write(*,*) '           The observation files are NOT split'
	burp_split_L = .false.  
	burp_split_mode = 'DEFAULT'
        ! At this point the code only supports split files
        write(*,*) 'top_setup: Expecting split burp files!'
        call varAbort('top_setup')
      else
        write(*,*)
        write(*,*) 'top_setup: The environment variable ARMA_BURP_SPLIT has correctly been detected'
	select case ( trim(burp_split_mode) )
	case ('yes')
	   write(*,*) 'top_setup: The observation files ARE split. Assuming ROUNDROBIN strategy'
	   burp_split_L = .true.
	   burp_split_mode = 'ROUNDROBIN'
        case ('no')
	   write(*,*) 'top_setup: The observation files are NOT split'
	   burp_split_L = .false.
	   burp_split_mode = 'DEFAULT'
           ! At this point the code only supports split files
           write(*,*) 'top_setup: Expecting split burp files!'
           call varAbort('top_setup')
        case ('ROUNDROBIN')
	   write(*,*) 'top_setup: The observation files	ARE split using the ROUNDROBIN strategy'
	   burp_split_L = .true.
	case ('LATLONTILES')
	   write(*,*) 'top_setup: The observation files	ARE split by LAT-LON tiles'
           write(*,*) 'top_setup: LAT-LON TILES NO LONGER PERMITTED, USE ROUND ROBIN!'
           call varAbort('top_setup')
        case default
           write(*,*) 'top_setup: Unknown burp_split_mode ', trim(burp_split_mode)
           call varAbort('top_setup')
        end select
      end if

    end subroutine top_setup

!--------------------------------------------------------------------------
! top_AnalysisMode
!--------------------------------------------------------------------------
    function top_AnalysisMode() result(analysisMode)
      implicit none
      logical :: analysisMode

      analysisMode= (top_nconf.eq.141)
        
    end function top_AnalysisMode

!--------------------------------------------------------------------------
! top_OmpMode
!--------------------------------------------------------------------------
    function top_OmpMode() result(ompMode)
      implicit none
      logical :: ompMode

      ompMode= (top_nconf.eq.121)
        
    end function top_OmpMode

!--------------------------------------------------------------------------
! top_BgckIrMode
!--------------------------------------------------------------------------
    function top_BgckIrMode() result(bgckMode)
      implicit none
      logical :: bgckMode

      bgckMode= (top_nconf.eq.111)
        
    end function top_BgckIrMode

!--------------------------------------------------------------------------
! top_BgckConvMode
!--------------------------------------------------------------------------
    function top_BgckConvMode() result(bgckMode)
      implicit none
      logical :: bgckMode

      bgckMode= (top_nconf.eq.101)
        
    end function top_BgckConvMode

!--------------------------------------------------------------------------
! top_BurpSplitMode
!--------------------------------------------------------------------------
    function top_BurpSplitMode() result(BurpSplitMode)
      implicit none
      character(len=48) :: BurpSplitMode

      BurpSplitMode = trim(burp_split_mode)
        
    end function top_BurpSplitMode

!--------------------------------------------------------------------------
! top_BurpSplit
!--------------------------------------------------------------------------
    function top_BurpSplit() result(BurpSplit)
      implicit none
      logical :: BurpSplit

      BurpSplit = burp_split_L
        
    end function top_BurpSplit

!--------------------------------------------------------------------------
! top_spatialDimensions
!--------------------------------------------------------------------------
    function top_spatialDimensions() result(spatialDimensions)
      implicit none
      character(len=2) :: spatialDimensions

      spatialDimensions = top_spatial_Dimensions

    end function top_spatialDimensions

!--------------------------------------------------------------------------
! top_AnalysisLevel2d
!--------------------------------------------------------------------------
    function top_AnalysisLevel2d() result(AnalysisLevel2d)
      implicit none
      integer :: AnalysisLevel2d(1)

      AnalysisLevel2d = top_ip1

    end function top_AnalysisLevel2d

end module topLevelControl_mod
