#!/bin/ksh

$SEQ_BIN/nodelogger -n $SEQ_NODE -s infox -m "Downloading input: $(${TASK_BIN}/readlink ${TASK_INPUT}/${SHORT_DATE}.ca)"
${TASK_BIN}/remote_copy $(readlink ${TASK_INPUT}/${SHORT_DATE}.ca) ${SHORT_DATE}.ca
${TASK_BIN}/cmcarc -f ${SHORT_DATE}.ca -x "banco\.bgckalt\.${SHORT_DATE}_.*" -v
mkdir ${TASK_OUTPUT}/observations
for file in banco.bgckalt.${SHORT_DATE}_*; do
    mv ${file} ${TASK_OUTPUT}/observations/$(echo $file | cut -d. -f3)
done

if [ "${PREVIOUS_DATE}" != "${SHORT_DATE}" ]; then
    rm ${SHORT_DATE}.ca

    $SEQ_BIN/nodelogger -n $SEQ_NODE -s infox -m "Downloading input: $(${TASK_BIN}/readlink ${TASK_INPUT}/${PREVIOUS_DATE}.ca)"
    ${TASK_BIN}/remote_copy $(${TASK_BIN}/readlink ${TASK_INPUT}/${PREVIOUS_DATE}.ca) ${PREVIOUS_DATE}.ca
fi

${TASK_BIN}/cmcarc -f ${PREVIOUS_DATE}.ca -x "trial\.model\.${PREVIOUS_DATE}_.*" -v
mkdir ${TASK_OUTPUT}/trials
for file in trial.model.${PREVIOUS_DATE}_*; do
    mv ${file} ${TASK_OUTPUT}/trials/$(echo $file | cut -d. -f3)
done

if [ -n "${ENVAR_precon_input}" ]; then
    if [ "${ENVAR_precon_input}" != no ]; then
	${TASK_BIN}/cmcarc -f ${PREVIOUS_DATE}.ca -x "anal\.anl\.model\.${PREVIOUS_DATE}_precon" -v
	mv anal.anl.model.${PREVIOUS_DATE}_precon ${TASK_OUTPUT}/precon
    fi
fi

rm ${PREVIOUS_DATE}.ca
