#!/bin/ksh

. ssmuse-sh -d eccc/cmd/cmda/utils/16.2-4

for fileinput in ${TASK_INPUT}/inputs/*.ca; do
    input=$(readlink ${fileinput})
    $SEQ_BIN/nodelogger -n $SEQ_NODE -s infox -m "Downloading input: ${input}"
    if [ -f "${input}" ]; then
        ln -s ${input} inputs.ca
    else
        ${TASK_BIN}/remote_copy ${input} inputs.ca
    fi

    ${TASK_BIN}/cmcarc -f inputs.ca -x -v
    rm inputs.ca
    mv * ${TASK_OUTPUT}
done

cd ${TASK_OUTPUT}

# if lwritediagsql=.true. in the namelist, the ObsSpaceData content is saved in sqlite files
# empty sqlite files should be created prior to the fortran code execution using rdbgen -f 'emptyFile.rdb' -type ${obsFamily} 
if grep -i "lwritediagsql" "${UnitTest_run_namelist}"
then
  for directory in burpfiles_*; do
    if [ -d "${directory}" ]; then

	obsFamily=${directory#*_}

	if [[ $obsFamily = to_* ]]; then
	  obsFamily=${obsFamily#*_}
	elif [[ $obsFamily = 'ssmis' ]]; then
	  obsFamily='ssmi' 	
        elif [[ $obsFamily = 'gp' || $obsFamily = 'sc' || $obsFamily = 'sfc' ]]; then
	  obsFamily='sf'  
	elif [[ $obsFamily = 'uan' || $obsFamily = 'uas' ]]; then
	  obsFamily='ua'
	fi

	cd ${directory}
	rdbgen -f 'emptyFile.rdb' -type ${obsFamily}
        for files in *; do
          cp emptyFile.rdb  ${files}'.rdb'
        done
	cd ../
    fi
done
fi
