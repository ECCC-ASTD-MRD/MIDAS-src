#! /bin/sh

###############################################################################
##  MIDAS automated build script
##
##  @SYNOPSIS
##      * edit configuration: `./config.dot.sh`
##
##      * compile, link and install all programs on both architectures
##        ```
##        ./midas_build
##        ```
##      * build specific targets on both architectures
##        ```
##        ./midas_build [ <target_1> [ <target_2> [ ... ] ] ]
##        ```
##  
##      * install auto-completion feature
##        ```
##        ./install_build_completion.sh
##        source ${HOME}/.bash_completion
##        source ${HOME}/.profile.d/interactive/post
##        ```
##
##  @REFERENCES 
##      * `./README.md`
##      * `./Makefile`
##  
##  @AUTHORS
##      Martin Deshaies-Jacques (@mad001) - CMDA - January 2020
##
###############################################################################


##=========================================================
##  functions
function are_jobs_completed {
    set -e
    typeset jobid_front=$1
    typeset pid_back=$2

    typeset __sleep_interval=3
    typeset __front_done=0
    typeset __back_done=0
    while true; do
        __status=0

        if [ "${__front_done}" = 0 ]; then 
            jobchk -c ${MIDAS_COMPILE_FRONTEND} ${jobid_front} || __status=$?
            if [ "${__status}" -ne 0 ]; then
                echo "Compilation on ${MIDAS_COMPILE_FRONTEND}\
(jobid: ${jobid_front}) has finished."
                __front_done=1
        fi; fi

        if [ "${__back_done}" = 0 ]; then
        if [ $(ps ${pid_back} | wc -l) -le 1 ]; then
                echo "Compilation on ${MIDAS_COMPILE_BACKEND}\
(pid: ${pid_back}) has finished."
                __back_done=1
        fi; fi

        [ ${__front_done} == 1 -a ${__back_done} == 1 ] && break
        sleep ${__sleep_interval}
    done
}

function abs_path {
    abs_name=${1}
    platform=${2}
    typeset __abs_prfx=${MIDAS_COMPILE_DIR_MAIN}/${__exec_leafdir_midas}/midas-
    echo ${__abs_prfx}${abs_name}_${platform}-${__revnum}.Abs
}



##=========================================================
## some prior defitions and checks
typeset __target
typeset __job
typeset __job_header
typeset __here
typeset __abs_exist_list

## check if called from midas/src
##   install_build_completion.sh make midas_build visible from PATH
##   but won't work unless called in midas/src
__here=$(pwd)
__date=$(date +%Y%m%d%H%S)
if [ ! "$(realpath $0)" == "$(pwd -P)/midas_build" ]
then
    echo '`midas_build` need to be called from `src`'
    exit 1
fi 

##=========================================================
##  sourcing user configuration

## env. variable new naming convention + retrocompatibility
__toplevel=$(git rev-parse --show-toplevel)
source ${__toplevel}/src/programs/commons/retroComp_warning.sh
##--------------------------------------------------------

source ${__here}/config.dot.sh  &> .tmp.config.out
__listing_config=${MIDAS_COMPILE_JOBNAME}.config-${__date}.out
mv .tmp.config.out ${__listing_config}


##=========================================================
##  parsing input and build job submissions
##

if [ $# -eq 0 ]
## default: make all 
then 
    __abs_exist_list=$(ls programs/*.f90 | sed 's/programs\/\(.*\).f90/\1/' )
    __job="make all -j ${MIDAS_COMPILE_NCORES} -O  MIDAS_COMPILE_DIR_MAIN=${MIDAS_COMPILE_DIR_MAIN} MIDAS_COMPILE_ADD_DEBUG=${MIDAS_COMPILE_ADD_DEBUG} MIDAS_COMPILE_COMPF_GLOBAL=${MIDAS_COMPILE_COMPF_GLOBAL} MIDAS_COMPILE_VERBOSE=${MIDAS_COMPILE_VERBOSE}"
else
    __target=$@
    __abs_exist_list=$(echo ${__target} | tr -s ' ' '\n'  | grep '.Abs' | sed 's/\.Abs//' | column )
    ## ^ there must be a simpler solution
    __job="make ${__target} -j ${MIDAS_COMPILE_NCORES} -O  MIDAS_COMPILE_DIR_MAIN=${MIDAS_COMPILE_DIR_MAIN} MIDAS_COMPILE_ADD_DEBUG=${MIDAS_COMPILE_ADD_DEBUG} MIDAS_COMPILE_COMPF_GLOBAL=${MIDAS_COMPILE_COMPF_GLOBAL} MIDAS_COMPILE_VERBOSE=${MIDAS_COMPILE_VERBOSE}"
fi

if [ "${__install_always_midas}" == "true" ]
then 
    __job="${__job} && make install -j ${MIDAS_COMPILE_NCORES} -O  MIDAS_COMPILE_DIR_MAIN=${MIDAS_COMPILE_DIR_MAIN} __exec_leafdir_midas=${__exec_leafdir_midas} MIDAS_COMPILE_VERBOSE=${MIDAS_COMPILE_VERBOSE}"
fi

##=========================================================
##  Check prior existence of absolutes
##  - remove them first
if [ ! -z "${__abs_exist_list}" ]; then
    echo "Checking prior existence of target absolutes"
    for __abs in ${__abs_exist_list}; do
    for __plat in ${ORDENV_PLAT} ${__plat_super}; do
        typeset __abs_full=$(abs_path ${__abs} ${__plat})
        [ -f  "${__abs_full}" ] && \
        ( echo "${__abs_full} exists; removing it" >>  ${__listing_config}
        rm ${__abs_full} )
    done; done
    echo
fi



##=========================================================
##  Compilation on backend (in the background)

##=========================================================
##  sourcing user configuration
source ./config.dot.sh

##=========================================================
##  Compilation on backend (in the background)
here=$(pwd)
cat > .compile_job << EOF
#! /bin/bash
set -ex
cd ${here}
source ${DOT_CONFIG} 
make ${__target} -j ${NCORES} -O  DIR_BLD_ROOT=${DIR_BLD_ROOT} VERBOSE=${VERBOSE}
EOF

__listing_backend=${MIDAS_COMPILE_JOBNAME}.${MIDAS_COMPILE_BACKEND}-${__date}.out
echo "========================================================================"
echo "... Launching direct compilation on ${MIDAS_COMPILE_BACKEND}"
echo "    > listing_${__listing_backend}" 
(cat .compile_job | ssh ${MIDAS_COMPILE_BACKEND} bash --login > \
    ${__listing_backend} 2>&1) &  
__pid_backend=$!
echo "    ${MIDAS_COMPILE_BACKEND} compilation process id: ${__pid_backend}"

##=========================================================
##  Compilation on frontend
echo "========================================================================"
echo "... Launching compilation on ${MIDAS_COMPILE_FRONTEND}"
if ${MIDAS_COMPILE_ON_MIDAS_COMPILE_FRONTEND_HEADNODE}
then
    ## compile directly on head node
    __listing_frontend=${MIDAS_COMPILE_JOBNAME}.${MIDAS_COMPILE_FRONTEND}-${__date}.out
    echo "    > ${__listing_frontend}"
    echo ${__job}
    ${__job} >  ${__listing_frontend} 2>&1 &
    __pid_frontend=$!
else
    ## use ord_soumet
    __jobid_frontend=$(ord_soumet .compile_job -jn ${MIDAS_COMPILE_JOBNAME} \
        -mach ${MIDAS_COMPILE_FRONTEND} -listing ${PWD} -w 60 \
        -cpus ${MIDAS_COMPILE_NCORES}  -m 8G -shell /bin/bash)
    __listing_frontend_search="${MIDAS_COMPILE_JOBNAME}.${MIDAS_COMPILE_FRONTEND}-*-${TRUE_HOST}-$(date +%Y%m%d%H)*.out"
fi

## waiting for backend compilation to terminate
echo 
echo "Compilation underway in working directory: ${__build_dir_version}"
echo 

if ${MIDAS_COMPILE_ON_MIDAS_COMPILE_FRONTEND_HEADNODE}
then
    wait ${__pid_backend}
    echo 
    echo "Compilation completed successfully on ${MIDAS_COMPILE_BACKEND}"
    wait ${__pid_frontend}
    echo 
    echo "Compilation completed successfully on ${MIDAS_COMPILE_FRONTEND}"
else
    are_jobs_completed ${__jobid_frontend} ${__pid_backend} 
fi





## checking if linking has been successful
if [ ! -z "${__abs_exist_list}" ]; then 
    echo
    echo "Checking existence of target absolutes:"
    echo ${__abs_exist_list}
    echo
    typeset __status=0
    for __abs in ${__abs_exist_list}; do
    for __plat in ${ORDENV_PLAT} ${__plat_super}; do
        typeset __abs_full=$(abs_path ${__abs} ${__plat})
        if [ ! -f  "${__abs_full}" ]; then
            echo "    ${__abs_full} not found"
            __status=1
        else
            echo "${__abs_full} installed" >> .checkAbs 
        fi
    done; done

    if [ "${__status}" -eq 0 ]; then
        echo "    All programs have been compiled correctly!"
        echo
        echo "╔═════════════════════════════╗"
        echo "║                             ║"
        echo "║ MIDAS COMPILATION COMPLETED ║"
        echo "║                             ║"
        echo "╚═════════════════════════════╝"
        echo
        echo "  > ${MIDAS_COMPILE_DIR_MAIN}/${__exec_leafdir_midas}"
        echo
        if ${MIDAS_COMPILE_CLEAN}
        then
            echo 
            echo "MIDAS_COMPILE_CLEAN=true (in config.dot.sh)"
            echo " ... cleaning build directory "
            make clean MIDAS_COMPILE_DIR_MAIN=${MIDAS_COMPILE_DIR_MAIN} \
                MIDAS_COMPILE_VERBOSE=${MIDAS_COMPILE_VERBOSE}
        fi
    else
        echo
        echo "<!> Some programs could not compile <!>"
        echo 
        exit 1
    fi
fi



## Organizing logs
if [ -z ${__listing_frontend+x} ]
then 
    __listing_frontend=$(ls -rt ${__listing_frontend_search} | tail -1) 
fi
cat ${__listing_frontend} >> ${__listing_config}
mv ${__listing_config} ${__listing_frontend}
[ -f ".checkAbs" ] && (cat .checkAbs >> ${__listing_frontend} && rm .checkAbs)
[ "${__keep_jobsubmit_ofile}" = false ] && rm -rf ${__listing_frontend}.o
rm -rf .compile_job
