module burpFiles_mod
  use mpi
  implicit none
  save
  private

  public :: burp_nfiles,burp_cfamtyp,burp_cfilnam
  public :: burp_setupfiles
  
  integer, parameter :: jpfiles=16
  integer :: burp_nfiles
  character(len=2)   :: burp_cfamtyp(jpfiles)
  character(len=128) :: burp_cfilnam(jpfiles)

contains


SUBROUTINE burp_setupfiles(datestamp)
  implicit none
!s/r  setup_burpfiles -INITIALZE BURP FILE NAMES and return datestamp
!
!
  INTEGER INFIL,IER,INBLKS,nulburp,JJ
  INTEGER FNOM,FCLOS,NUMBLKS
  PARAMETER(INFIL=129)
  CHARACTER *64 CLVALU(INFIL),CFAMI(INFIL)
  CHARACTER(len=4) :: cmyidx, cmyidy
  CHARACTER(len=9) :: cmyid
  CHARACTER(len=128) :: burpin   
  LOGICAL   isExist_L 
!************************************************************************
  INTEGER KTIME,KDATE
  INTEGER IHANDL,ILONG,DATESTAMP
  INTEGER ITIME,IFLGS,IDBURP,ILAT,ILON,IDX,IDY
  INTEGER IALT,IDELAY,IDATE,IRS,IRUNN,INBLK,ISUP,IXAUX
  INTEGER INSUP,INXAUX

  INTEGER, ALLOCATABLE :: IBUF(:)
  INTEGER INRECS
  INTEGER MRFCLS,MRFOPN,MRFOPC,MRBHDR,MRFLOC,MRFGET
  INTEGER MRFMXL

  INTEGER NBRPDATE,NBRPHH,ISTAMPOBS,INEWHH,NEWDATE
  REAL*8 DELHH
  INTEGER       IVALS
  CHARACTER*9   CLSTNID

  EXTERNAL FCLOS,FNOM,MRFCLS,MRFOPN,MRFOPC,MRBHDR,MRFLOC,MRFGET,MRFMXL,NUMBLKS

!************************************************************************
  write(cmyidy,'(I4.4)') (mpi_nprocs-mpi_myid)
  !! later, when the mpi along longitudes bands will be implemented, then
  !! this 'cmyidx' and 'cmyidy' will change
  cmyidx = '0001'
  cmyid  = trim(cmyidx)//'_'//trim(cmyidy)

  CLVALU(10) = 'brpuan'  
  CLVALU(11) = 'brpuas'  
  CLVALU(12) = 'brpai'  
  CLVALU(13) = 'brpain'  
  CLVALU(14) = 'brpais'  
  CLVALU(15) = 'brpaie'  
  CLVALU(16) = 'brpaiw'  
  CLVALU(17) = 'brpsfc'  
  CLVALU(18) = 'brpsf'  
  CLVALU(19) = 'brptov'  
  CLVALU(20) = 'brpssmis'
  CLVALU(21) = 'brpairs'
  CLVALU(22) = 'brpto_amsua'
  CLVALU(23) = 'brpto_amsub'
  CLVALU(24) = 'brpcsr'
  CLVALU(25) = 'brpiasi'
  CLVALU(26) = 'brpsw'  
  CLVALU(27) = 'brpswgoes9'  
  CLVALU(28) = 'brpswgoese'  
  CLVALU(29) = 'brpswgoesw'  
  CLVALU(30) = 'brpswmodis'  
  CLVALU(31) = 'brpswmtsate'  
  CLVALU(32) = 'brpswmtsatw'  

  CLVALU(33) = 'brpgo'  
  CLVALU(34) = 'brpsc'  
  CLVALU(35) = 'brppr'  
  CLVALU(36) = 'brpro'  
  CLVALU(37) = 'brphum'  
  CLVALU(38) = 'brpsat'  
  CLVALU(39) = 'brpssm'  
  CLVALU(40) = 'brpo3'  
  CLVALU(41) = 'brpoz'  
  CLVALU(42) = 'brpgp'  
  
  CLVALU(43) = ' '  

  CFAMI(10)  = 'UA' 
  CFAMI(11)  = 'UA' 
  CFAMI(12)  = 'AI' 
  CFAMI(13)  = 'AI' 
  CFAMI(14)  = 'AI'
  CFAMI(15)  = 'AI'
  CFAMI(16)  = 'AI'
  CFAMI(17)  = 'SF' 
  CFAMI(18)  = 'SF' 
  CFAMI(19)  = 'TO' 
  CFAMI(20)  = 'TO' 
  CFAMI(21)  = 'TO' 
  CFAMI(22)  = 'TO' 
  CFAMI(23)  = 'TO' 
  CFAMI(24)  = 'TO' 
  CFAMI(25)  = 'TO' 
  CFAMI(26)  = 'SW' 
  CFAMI(27)  = 'SW' 
  CFAMI(28)  = 'SW' 
  CFAMI(29)  = 'SW' 
  CFAMI(30)  = 'SW' 
  CFAMI(31)  = 'SW' 
  CFAMI(32)  = 'SW' 
  CFAMI(33)  = 'GO' 
  CFAMI(34)  = 'SC' 
  CFAMI(35)  = 'PR' 
  CFAMI(36)  = 'RO' 
  CFAMI(37)  = 'HU' 
  CFAMI(38)  = 'ST' 
  CFAMI(39)  = 'MI' 
  CFAMI(40)  = 'OZ' 
  CFAMI(41)  = 'OZ' 
  CFAMI(42)  = 'GP' 

  CFAMI(43)  = ' ' 

  IER =MRFOPC('MSGLVL','FATAL')

  IVALS=8
  KDATE=-9999
  KTIME=-9999
  burp_nfiles=0
  DO JJ=10,INFIL 
    IF(CLVALU(JJ) == '') EXIT
    nulburp=0
    burpin=trim(CLVALU(JJ))//'_'//trim(cmyid)
    INQUIRE(FILE=trim(burpin),EXIST=isExist_L)
    IF (.NOT. isExist_L )THEN
      burpin=trim(CLVALU(JJ))
      INQUIRE(FILE=trim(burpin),EXIST=isExist_L)
    END IF
    IF ( isExist_L )THEN
      IER=FNOM(nulburp,burpin,'RND+OLD',0)
      WRITE(*,*)' Open File : ',burpin   
      IF ( IER .EQ. 0 ) THEN
        INBLKS= -1
        INBLKS=NUMBLKS(nulburp)
        IF ( INBLKS .GT. 0 ) THEN
          INRECS=MRFOPN(NULBURP,'READ')
          ILONG =MRFMXL(NULBURP)
          ALLOCATE(IBUF(ILONG + 20))
          IBUF(1)=ILONG + 20
          IHANDL  =MRFLOC(NULBURP,0,'>>*******',-1,-1,-1,-1,-1,-1,0)
          IF ( IHANDL .LT. 0 ) THEN
            IHANDL=MRFLOC(NULBURP,0,'*********',-1,-1,-1,-1,-1,-1,0)
          ENDIF
          IF ( IHANDL .LT. 0 ) THEN
            WRITE(*,*) 'AUCUN ENREGISTREMENT VALIDE DANS LE FICHIER BURP'
          ELSE
            burp_nfiles=burp_nfiles + 1
            burp_cfilnam(burp_nfiles)=burpin
            burp_cfamtyp(burp_nfiles)=CFAMI(JJ)
            INSUP=0
            INXAUX=0
            IER=MRFGET(IHANDL,IBUF)
            IER=MRBHDR(IBUF,ITIME,IFLGS,CLSTNID,IDBURP,ILAT,   &
              ILON,IDX,IDY, IALT,IDELAY,IDATE,IRS,IRUNN,INBLK, &
              ISUP,INSUP,IXAUX,INXAUX)
            KTIME=ITIME
            KDATE=IDATE
          ENDIF
          DEALLOCATE(IBUF)
          IER=MRFCLS(NULBURP)
        ENDIF
      ENDIF
      IER= FCLOS(nulburp)
    ENDIF
  END DO

  WRITE(*,*) ' '
  WRITE(*,*)' NUMBER OF BURP FILES IS :',burp_nfiles
  WRITE(*,*)'TYPE  NAME '
  WRITE(*,*)'----  ---- '
  DO JJ=1,burp_nfiles
    WRITE(*,'(1X,A2,1X,A128)' ) burp_cfamtyp(JJ),burp_cfilnam(JJ)
  END DO

  ! Make sure all mpi tasks have a valid date (important for split burp files)
  call rpn_comm_allreduce(kdate,kdate,1,"MPI_INTEGER","MPI_MAX","GRID",ier)
  call rpn_comm_allreduce(ktime,ktime,1,"MPI_INTEGER","MPI_MAX","GRID",ier)

  ier = newdate(istampobs,kdate,ktime,3)
  delhh = 3.0d0
  call INCDATR (datestamp, istampobs, delhh)
  ier = newdate(datestamp,nbrpdate,inewhh,-3)
  nbrphh=KTIME/100
  if (nbrphh .ge. 21 .or. nbrphh .lt. 3) then
    nbrphh = 0
  elseif(nbrphh .ge. 3 .and. nbrphh .lt. 9) then
    nbrphh = 6
  elseif(nbrphh .ge. 9 .and. nbrphh .lt. 15) then
    nbrphh = 12
  else
    nbrphh = 18
  endif
  ier = newdate(datestamp,nbrpdate,nbrphh*1000000,3)
  WRITE(*, *)' BURP FILES VALID DATE (YYYYMMDD) : ',nbrpdate
  WRITE(*, *)' BURP FILES VALID TIME       (HH) : ',nbrphh

END SUBROUTINE burp_setupfiles

end module burpFiles_mod
