!--------------------------------------------------------------------------
! MODULE controlVector (The control vector and related information.  prefix="cvm")
!
! Purpose: 
!
! Subroutines:
!    cvm_setup (public)
!
! Dependencies:
!
!--------------------------------------------------------------------------
MODULE ControlVector

  implicit none
  save
  private

  public              :: cvm_Setup, cvm_deallocate, cvm_getSubVector, cvm_vazx, cvm_nvadim

  logical             :: initialized = .false.
  integer             :: cvm_dimBHI = 0
  integer             :: cvm_dimBEN = 0
  integer             :: cvm_nvadim

  real*8, allocatable,target :: cvm_vazx(:)

CONTAINS

  SUBROUTINE CVM_setup(DIMBHI_IN,DIMBEN_IN)
    implicit none

    integer        :: dimBHI_in,dimBEN_in
    integer        :: ierr

    cvm_dimbhi = dimbhi_in
    cvm_dimben = dimben_in
    cvm_nvadim = cvm_dimben + cvm_dimbhi

    allocate(cvm_vazx(cvm_nvadim),stat=ierr)
    if(ierr.ne.0) then
      write(*,*) 'controlVector: Problem allocating memory! id=1',ierr
      call flush(6)
    endif

    cvm_vazx(:)=0.0d0

    initialized=.true.

  END SUBROUTINE CVM_setup

  FUNCTION CVM_getSubVector(controlVector,subVectorIndex) RESULT(subVector)
    implicit none

    real*8, pointer :: subVector(:)
    real*8,target   :: controlVector(:)
    integer         :: subVectorIndex

    nullify(subVector)

    if(subVectorIndex.eq.1 .and. cvm_dimbhi.gt.0) then
      subVector => controlVector(1:cvm_dimbhi)
    elseif(subVectorIndex.eq.2 .and. cvm_dimben.gt.0) then
      subVector => controlVector((cvm_dimbhi+1):(cvm_dimbhi+cvm_dimben))
    else
      write(*,*) 'CVM_getSubVector: subVectorIndex ',subVectorIndex,' is not available'
      call flush(6)
    endif

  END FUNCTION CVM_getSubVector

  SUBROUTINE CVM_deallocate
    implicit none

    integer :: ierr

    if (allocated(cvm_vazx))then
      deallocate(cvm_vazx,stat=ierr)
      if(ierr.eq.0) then
        write(*,*) 'CVM_VAZX checked and correct. IERR =',ierr
      else
        write(*,*) 'Problem detected in CVM_VAZX. IERR =',ierr
      endif
    end if

  END SUBROUTINE CVM_deallocate

END MODULE ControlVector
