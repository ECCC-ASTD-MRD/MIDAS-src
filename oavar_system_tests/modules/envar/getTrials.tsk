#!/bin/ksh
#.*****************************************************************************
#.
#.     JOB NAME - getTrials
#.
#.     STATUS - OPERATIONAL - ESSENTIAL
#.
#.     DESCRIPTION - This task gets the GDPS trial field files needed to do the analysis.  
#.
#.*****************************************************************************

INPUT_TRIALS=$(${TASK_BIN}/readlink ${TASK_INPUT}/trials)
${SEQ_BIN}/nodelogger -n ${SEQ_NODE} -s infox -m  "Get trials from ${INPUT_TRIALS}"

if [ -d "${INPUT_TRIALS}" ]; then
    if [ -n "${ENVAR_trial_extension}" ]; then
	trial_missing=0
	for ext in ${ENVAR_trial_extension}; do
	    file=${INPUT_TRIALS}/${ENVAR_trial_prefix}${__ENVAR_DATE_m6}_${ext}
	    if [ -f "${file}" ]; then
		${SEQ_BIN}/nodelogger -n ${SEQ_NODE} -s infox -m  "Get file ${file}"
		ln -s ${file} .
	    else
		${SEQ_BIN}/nodelogger -n ${SEQ_NODE} -s infox -m  "missing file: ${file}"
		trial_missing=1
	    fi
	done
	if [ "${trial_missing}" -ne 0 ]; then
	    exit 1
	fi
    else
	for file in ${INPUT_TRIALS}/${ENVAR_trial_prefix}${__ENVAR_DATE_m6}_*; do
	    ${SEQ_BIN}/nodelogger -n ${SEQ_NODE} -s infox -m  "Get file ${file}"
	    if [ -f "${file}" ]; then
		ln -s ${file} .
	    else
		${SEQ_BIN}/nodelogger -n ${SEQ_NODE} -s infox -m "No trial is available"
		exit 1
	    fi
	done
    fi
else
    if [ -n "${ENVAR_trial_extension}" ]; then
	trial_missing=0
	for ext in ${ENVAR_trial_extension}; do
	    ${TASK_BIN}/remote_copy ${INPUT_TRIALS}/${ENVAR_trial_prefix}${__ENVAR_DATE_m6}_${ext} ${TRUE_HOST}:${PWD}/. || trial_missing=1
	    if [ ! -f "${ENVAR_trial_prefix}${__ENVAR_DATE_m6}_${ext}" ]; then
		${SEQ_BIN}/nodelogger -n ${SEQ_NODE} -s infox -m "File missing: ${INPUT_TRIALS}/${ENVAR_trial_prefix}${__ENVAR_DATE_m6}_${ext}"
	    fi
	done
	if [ "${trial_missing}" -ne 0 ]; then
	    exit 1
	fi
    else
	trial_missing=0
	${TASK_BIN}/remote_copy ${INPUT_TRIALS}/${ENVAR_trial_prefix}${__ENVAR_DATE_m6}_* ${TRUE_HOST}:${PWD}/. || trial_missing=1
	if [ "${trial_missing}" -ne 0 ]; then
	    ${SEQ_BIN}/nodelogger -n ${SEQ_NODE} -s infox -m "No trial is available"
	    exit 1
	fi
    fi
fi

${SEQ_BIN}/nodelogger -n ${SEQ_NODE} -s infox -m "Put trials in $(${TASK_BIN}/true_path ${TASK_OUTPUT})"
for file in *${__ENVAR_DATE_m6}_*; do
    mv ${file} ${TASK_OUTPUT}
done

if [ -L ${TASK_INPUT}/precon ]; then
    file=$(${TASK_BIN}/readlink ${TASK_INPUT}/precon)
    if [ -f "${file}" ]; then
	ln -s ${file} ${TASK_OUTPUT}/precon
    else
	precon_missing=0
	${TASK_BIN}/remote_copy ${file} precon || precon_missing=1
	if [ "${precon_missing}" -ne 0 ]; then
	    ${SEQ_BIN}/nodelogger -n ${SEQ_NODE} -s infox -m "preconditioning file not available '${file}'"
	    exit 1
	fi
	mv precon ${TASK_OUTPUT}/precon
    fi
    ${SEQ_BIN}/nodelogger -n ${SEQ_NODE} -s infox -m  "Using ${file} as 'precon' for warm start of the 3D-Var or EnVar"
elif [ "${ENVAR_precon_input}" != '<no value>' -a "${ENVAR_precon_input}" != 'no' ]; then
    ${SEQ_BIN}/nodelogger -n ${SEQ_NODE} -s info -m  "Preconditing file is not available for warm start of the 3D-Var or EnVar"
fi
