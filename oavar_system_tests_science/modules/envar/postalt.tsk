#!/bin/ksh
#.*****************************************************************************
#.
#.     JOB NAME - postalt
#.
#.     STATUS - OPERATIONAL - ESSENTIAL
#.
#.     DESCRIPTION - This tasks manipulates the burp files output from the VAR task
#.                   to generate the 'postalt' burp file.  
#.
#.*****************************************************************************

mkdir brpfiles
ln -s $(ls -1 ${TASK_INPUT}/brpfiles/brp* | grep -v num_headers) brpfiles

if [ "${ENVAR_postalt_output_mode}" = "one" ]; then
    echo "
 EXCLURE('>>*******',-1 ,-1 ,-1 ,-1,-1,-1,-1,-1)
" > dir_post1
    #

    echo "
 DESIRE('>>*******',-1 ,-1 ,-1 ,-1,-1,-1,-1,-1)
" > dir_post2

    for file in brpfiles/*; do
        bfile=$(basename ${file})
        ln -s ${file} ${bfile}
        ${TASK_BIN}/editbrp -s ${bfile} -d post_3dvar -i dir_post1
    done

    for file in brpsfc* brpai* brpuan* brpuas*; do
        if [ -f "${file}" ]; then
	    ${TASK_BIN}/editbrp -s ${file} -d resume_rec -i dir_post2 -c 1
	fi
    done
    ${TASK_BIN}/editbrp -s resume_rec -d post_3dvar -c 1

    ${TASK_BIN}/reflex -ixent post_3dvar -oxsrt post_final

    mv post_final ${TASK_OUTPUT}/postalt

else ## Fin du 'if [ "${ENVAR_postalt_output_mode}" = "one" ]'

    mkdir ${TASK_OUTPUT}/postalt

    echo "
 EXCLURE('>>*******',-1 ,-1 ,-1 ,-1,-1,-1,-1,-1)
" > dir_excl_res
    #

    echo "
 DESIRE('>>*******',-1 ,-1 ,-1 ,-1,-1,-1,-1,-1)
" > dir_res

    ## On regroupe les fichier 'uas' et 'uan' ensemble
    cd brpfiles
    if [ -f brpuan ]; then
	${TASK_BIN}/reflex -ixent brpuan -oxsrt brpua
	rm brpuan
    fi
    if [ -f brpuas ]; then
	${TASK_BIN}/reflex -ixent brpuas -oxsrt brpua
	rm brpuas
    fi
    cd ..

    for file in brpfiles/*; do
	bfile=$(basename ${file})
	fam=$(echo ${bfile} | cut -c4-)
	[ -L ${bfile} ] && rm ${bfile}
	ln -s ${file} ${bfile}
	if [ "${fam}" != tov ]; then
	    ## Si les fichiers 'brptov' sont deja separes alors on passera toujours dans cette partie
	    ${TASK_BIN}/editbrp -s ${bfile} -d brp${fam}.nores -i dir_excl_res
	    ${TASK_BIN}/editbrp -s ${bfile} -d res${fam} -i dir_res -c 1
	else
	    ${TASK_BIN}/editbrp -s ${bfile} -d restov -i dir_res -c 1
	    ${TASK_BIN}/editbrp -s ${bfile} -d brpto_amsua.nores -i <<EOF
C  -----------------
C  FAMILLE TOVS AMSUA
C  -----------------
 DESIRE('*********',-1 ,-1 ,-1 ,164,-1,-1,-1,-1)
EOF
	    ${TASK_BIN}/editbrp -s ${bfile} -d brpto_amsub.nores -i <<EOF
C  -----------------
C  FAMILLE TOVS AMSUB/MHS
C  -----------------
 DESIRE('*********',-1 ,-1 ,-1 ,[181,182],-1,-1,-1,-1)
EOF
	    ${TASK_BIN}/editbrp -s ${bfile} -d brpairs.nores -i <<EOF
C  -----------------
C  FAMILLE airs
C  -----------------
 DESIRE('*********',-1 ,-1 ,-1 ,183,-1,-1,-1,-1)
EOF
	    ${TASK_BIN}/editbrp -s ${bfile} -d brpssmis.nores -i <<EOF
C  -----------------
C  FAMILLE ssmi/s
C  -----------------
 DESIRE('*********',-1 ,-1 ,-1 ,168,-1,-1,-1,-1)
EOF
	    ${TASK_BIN}/editbrp -s ${bfile} -d brpiasi.nores -i <<EOF
C  -----------------
C  FAMILLE iasi
C  -----------------
 DESIRE('*********',-1 ,-1 ,-1 ,186,-1,-1,-1,-1)
EOF
	    ${TASK_BIN}/editbrp -s ${bfile} -d brpcsr.nores -i <<EOF
C  -----------------
C  FAMILLE georad/csr
C  -----------------
 DESIRE('*********',-1 ,-1 ,-1 ,185,-1,-1,-1,-1)
EOF
	    ${TASK_BIN}/editbrp -s ${bfile} -d brpatms.nores -i <<EOF
C  -----------------
C  FAMILLE ATMS
C  -----------------
 DESIRE('*********',-1 ,-1 ,-1 ,192,-1,-1,-1,-1)
EOF
	    ${TASK_BIN}/editbrp -s ${bfile} -d brpcris.nores -i <<EOF
C  -----------------
C  FAMILLE CrIS
C  -----------------
 DESIRE('*********',-1 ,-1 ,-1 ,193,-1,-1,-1,-1)
EOF
	fi
	rm ${bfile}
    done

    if [ "${ENVAR_observations_brptov_grouping}" = yes ]; then
	for file in brpto_amsua brpto_amsub brpairs brpssmis brpiasi brpcsr brpatms brpcris; do
	    [ -f "${file}" ] && rm ${file}
	    if [ -f ${file}.nores ]; then
		mv ${file}.nores ${file}
		fam=$(echo ${file} | cut -c4-)
		if [ -f res${fam} ]; then
		    ${TASK_BIN}/editbrp -s res${fam} -d ${file} -c 1
		else
		    ${TASK_BIN}/editbrp -s restov -d ${file} -c 1
		fi
		${TASK_BIN}/reflex -ixent ${file} -oxsrt ${file}.reflex
		mv ${file}.reflex ${TASK_OUTPUT}/postalt/${file}
		rm ${file}
	    fi
	done
    fi

    for file in brp*; do
	if [ -f "${file}" ]; then
	    bfile=$(basename ${file} .nores)
	    fam=$(echo ${bfile} | cut -c4-)
	    ${TASK_BIN}/editbrp -s res${fam} -d ${bfile} -c 1
	    ${TASK_BIN}/reflex -ixent ${file} -oxsrt ${bfile}
	    mv ${bfile} ${TASK_OUTPUT}/postalt/${bfile}
	    rm ${file}
	fi
    done

fi ## Fin du 'else' relie au 'if [ "${ENVAR_postalt_output_mode}" = "one" ]'
