variables:
    # CI_DEBUG_TRACE: "true"
    MIDAS_ABS: /home/sanl000/data_maestro/ords/midas/gitlab-ci/abs

stages:
   - build
   - test
   - doc

## The program 'gitlab-runner' must be found in the PATH to get the artifacts collecting working.
#before_script:
#    - ln -svf /home/sidr000/bin/gitlab-ci-multi-runner-linux-amd64 ${TMPDIR}/bin
#    - ln -svf gitlab-ci-multi-runner-linux-amd64 ${TMPDIR}/bin/gitlab-runner

build:
  stage: build
  script:
    - cd src/programs
    - ./compile_all_plat.sh $MIDAS_ABS
  only:
    - master
    - v_3.3

runtests:
   stage: test
   variables:
     SEQ_MAESTRO_SHORTCUT: ". ssmuse-sh -d eccc/cmo/isst/maestro/1.5.3.3"
     MAKE_LINKS_MACHINE_LIST: "eccc-ppp3 eccc-ppp4 banting daley"
   script:
     - . ssmuse-sh -d eccc/cmd/cmdi/utils/2.0
     - cd maestro/suites/midas_system_tests
     - suite=midas-$(echo ${CI_BUILD_REF} | cut -c-10)
     - ./install_suite.sh $suite run $MIDAS_ABS
     - ./wait4tests.sh $suite
     - ./extractRunTime.sh $suite
     - ./collect_unittest_listings
     - clean_suite $suite
     - rm ~/.suites/${suite}
     - rmdir ~/data_maestro/ords/maestro/$suite
   only:
     - master
     - v_3.3

doc_f90doc:
  stage: doc
  variables:
    docname: $CI_BUILD_REF_NAME-$CI_BUILD_REF
    midasdoc: /home/sanl000/public_html/midas-doc
  script:
  - scripts/create_f90doc.sh $CI_PROJECT_DIR/src $midasdoc/$docname
  - rm -fv $midasdoc/latest
  - ln -sv $midasdoc/$docname $midasdoc/latest
  only:
    - master

doc_sphinx:
  stage: doc
  variables:
    docname: $CI_BUILD_REF_NAME-$CI_BUILD_REF
    midasdoc: /home/sanl000/public_html/midas-sphinx-doc
  script:
  - cd scripts/sphinx
  - ./build_html.sh ../../src $midasdoc/$docname
  - rm -fv $midasdoc/latest-$CI_BUILD_REF_NAME
  - ln -sv $midasdoc/$docname $midasdoc/latest-$CI_BUILD_REF_NAME
  only:
    - master
    - v_3.3
